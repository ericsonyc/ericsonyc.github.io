---
layout: post
author: Ericson
date: 2015-11-22 22:12
title: Java类加载机制
category: java
tag: [java,class loading]
---

Java类加载器除了根类加载器之外，其他的都是用java语言编写的。当运行某个java程序时，将会启动一个java虚拟机进程，该程序的所有线程都位于该java虚拟机中。两个JVM之间不能共享数据。

当程序主动使用某个类时，如果该类还未被加载到内存中，则系统会通知加载、连接、初始化3个步骤来对该类进行初始化。类加载指的是将类的class文件读入内存，并为之创建一个java.lang.Class对象。当类被加载之后，系统会为之生成一个对应的Class对象，接着将会进入连接阶段，连接阶段负责把类的二进制数据合并到JAR中。分为以下三个阶段：
<ul>
    <li>验证：验证阶段用于检验被加载的类是否有正确的内部结构，并和其他类协调一致</li>
    <li>准备：类准备阶段则负责为类的静态Field分配内存，并设置默认初始值</li>
    <li>解析：将类的二进制数据中的符号引用替换成直接引用</li>
</ul>
在类的初始化阶段，虚拟机负责对类进行初始化，主要就是对静态Field进行初始化。类加载器负责将.class文件加载到内存中，并为之生成对应的java.lang.Class对象。当JVM启动时，会形成3个类加载器组成的初始类加载器层次结构：
<ul>
    <li>Bootstrap ClassLoader：根类加载器</li>
    <li>Extension ClassLoader：扩展类加载器</li>
    <li>System ClassLoader：系统类加载器</li>
</ul>
Bootstrap ClassLoader被称为引导类加载器，它负责加载Java核心类。
{%highlight java%}
URL[] urls=sum.misc.Launcher.getBootstrapClassPath().getURLs();
for(int i=0;i<urls.length;i++){
    System.out.println(urls[i].toExternalForm());
}
{%endhighlight%}
Externsion ClassLoader被称为扩展类加载器，它负责加载JRE的扩展目录中JAR包的类。System ClassLoader被称为系统类加载器，它负责在JVM启动时加载来自java命令的-classpath选项、java.class.path系统属性或CLASSPATH环境变量所指定的JAR包和类路径。

JVM类加载器机制主要有3种：
<ul>
    <li>全盘负责：当一个类加载器负责加载某个Class时，该Class所依赖和引用的其他Class也将由该类加载器负责载入，除非显式使用另外一个类加载器来载入</li>
    <li>父类委托：则是让parent类加载器试图加载该Class，只有在父类加载器无法加载该类时才尝试从自己的类路径中加载该类</li>
    <li>缓存机制：保证所有加载过的Class都会被缓存，当程序中需要使用某个Class时，类加载器先从缓存区中搜索该Class，只有当缓存区中不存在该Class对象系统才会读取该类对应的二进制数据。</li>
</ul>