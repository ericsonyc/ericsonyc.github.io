---
layout: post
author: Ericson
date: 2015-11-21 10:14
title: Ping命令详解
category: Linux
tag: [linux,ping]
---

ping命令是查网络故障的常用命令，一下做一个总结。使用ping命令可以测试计算机名和计算机的ip地址，验证与远程计算机网络连接是否通畅。该命令只有在安装了tcp/ip协议后才可以使用。<font color="red">注：防火墙等网络数据包过滤工具可能会导致ping命令测试失败，导致屏结果出现Request timed out异常提示。</font>

<font size="3">ping命令使用</font>

在windows系统下，使用ping /?命令可以查看ping命令详解，如下图所示：

<div>
<img src="/public/img/linux/windowsping.jpg" width="500" height="500">
</div>

在Linux系统下，可以使用man ping命令来查看ping命令的使用。

<font size="3">ping命令原理</font>

源主机（输入ping命令的主机）向目标主机发送一个ICMP协议中的echo包；如目标主机存活，就向源主机返回一个ICMP协议的echo-reply包。

<font size="3">ping命令幕后过程，举例说明</font>

首先，我们以下面一个网络为例：有A、B、C、D四台主机，一台路由器RA连接以下两个子网。

<table>
<tr>
	<td>All</td>
	<td>ip</td>
	<td>mask</td>
</tr>
<tr>
	<td>A</td>
	<td>192.168.0.4</td>
	<td>255.255.255.0</td>
</tr>
<tr>
	<td>B</td>
	<td>192.168.0.5</td>
	<td>255.255.255.0</td>
</tr>
<tr>
	<td>C</td>
	<td>192.168.1.3</td>
	<td>255.255.255.0</td>
</tr>
<tr>
	<td>D</td>
	<td>192.168.1.4</td>
	<td>255.255.255.0</td>
</tr>
</table>

（1）在同一网段中：<br/>
在主机A上运行“ping 192.168.0.5”后，首先ping命令会构建一个固定格式的ICMP请求数据包，然后由ICMP协议将这个数据包连同地址“192.168.0.5”一起交给ip层协议（和ICMP一样，其实是一组后台运行的进程），ip层协议将以地址“192.168.0.5”作为目的地址，本地ip地址作为源地址，加上一些其他的控制信息，构建一个ip数据包，并想办法得到192.168.0.5的mac地址（物理地址，这是数据链路层协议构建数据链路层的传输单元——帧所必需的），以便交给数据链路层构建一个数据帧。关键就在这里，ip层协议通过对比机器B的ip地址、自己的ip地址和自己的子网掩码，发现它跟自己属于同一网络，就直接在本网络内查找这台机器的mac。如果以前两台主机有过通信，在A机的ARP缓存表中应该有B机ip与其mac的映射关系；如果没有，就发一个ARP请求广播看，得到B机的mac，一并交给数据链路层。后者构建一个数据帧，目的地址是ip层传过来的物理地址，源地址则是本机的物理地址，还要附加上一些控制信息，依据以太网的介质访问规则，将它们传送出去。

主机B收到这个数据帧后，先检查它的目的地址，并和本机的物理地址对比，如符合，则接收；否则丢弃。接收后检查该数据帧，将ip数据包从帧中提取出来，交给本机的ip层协议。同样，ip层检查后，将有用的信息提取后交给ICMP协议，后者处理后，马上构建一个ICMP应答包，发送给主机A，器过程和主机A发送的ICMP请求包到主机B一模一样。

（2）不在同一网段<br/>
在主机A上运行“ping 192.168.1.4”后，开始和上面一样，到获取mac地址时，ip协议通过计算发现D机与自己不在同一网段内，就直接将数据包交由路由器处理，也就是将路由器的mac取过来（获得路由器的mac过程和上面一样），路由得到这个数据帧后，再跟主机D进行联系，如果找不到，就像主机A返回一个超时的信息。

<font size="3">ping失败结果分析</font>

（1）Request timed out <br/>
<ul>
	<li>对方已关机，或者网络上根本没有这个地址</li>
    <li>对方与自己不在同一个网段内，通过路由也无法找到对方，但对方确实是存在的</li>
    <li>对方确实存在，但设置了ICMP数据包过滤（比如防火墙）</li>
    <li>错误设置ip地址</li>
</ul>
（2）Destination host Unreachable <br/>
<ul>
    <li>对方与自己不在同一网段内，而自己又未设置默认的路由</li>
    <li>网线出了故障</li>
</ul>
（3）Bad IP address
<ul>
	<li>表示可能没有连接到DNS服务器，所以无法解析这个IP地址，也可能是IP地址不存在</li>
</ul>
（4）Source quench received
<ul>
	<li>表示对方或中途的服务器繁忙无法回应</li>
</ul>
（5）Unknown host
<ul>
	<li>该远程主机的名字不能被DNS解析</li>
</ul>
（6）No answer
<ul>
	<li>本地系统有一条通向中心主机的路由，但却接收不到它发给该中心主机的任何信息</li>
</ul>
（7）no route to host
<ul>
	<li>网卡工作不正常</li>
</ul>